# Deployment Guide

This project ships as a Node.js API with a static front-end bundle generated by Vite. The production image now uses a multi-stage Docker build that compiles the client bundle, prunes development dependencies, and exposes `/health` for platform probes.

## Build Workflow

1. **Run automated tests locally** (the suite currently contains known failing corridor generator cases – see `tests/unit/lib/advancedCorridorGenerator.test.js` for tracking).
   ```bash
   npm install
   npm test
   ```
2. **Create the static bundle** (already executed in the Docker build, but useful when validating locally):
   ```bash
   npm run vite-build
   ```
3. **Build the production image**:
   ```bash
   docker build -t floorplan-pro:latest .
   ```
   The resulting image contains only production dependencies and the Vite output (`public/dist`). A runtime `node` user owns writable directories (`uploads`, `exports`, `logs`).

## Runtime Configuration

| Variable            | Purpose                                   | Default |
|---------------------|-------------------------------------------|---------|
| `PORT`              | HTTP port                                 | `3000`  |
| `NODE_ENV`          | Environment discriminator                  | `production` |
| `BIND_ADDRESS`      | Interface binding                         | `0.0.0.0` |
| `ADMIN_API_KEY`     | Optional admin route guard                | unset   |
| `APS_CLIENT_ID`     | Autodesk credentials (if APS features used) | unset |
| `APS_CLIENT_SECRET` | Autodesk credentials (if APS features used) | unset |

Add these as Platform / Render environment variables or via a `.env` file for local runs.

## Render Deployment

`render.yaml` now exposes:

```yaml
services:
  - type: web
    name: floorplan-pro
    env: docker
    plan: starter
    region: oregon
    autoDeploy: true
    healthCheckPath: /health
```

Render will call `/health` (JSON with uptime, cached floor plans, ML bootstrap status, and whether the bundled `public/dist` build is active). A non-200 response will fail the health check.

## Manual Verification Checklist

1. Verify `/health` returns `status: ok`, expected environment, `usingDist: true`, and a non-zero `uptimeSeconds`.
2. Verify `/healthz` (rich check) for persistence and APS status.
3. Upload a DXF or use the preset selector to ensure deterministic generation works end-to-end.
4. Confirm exported files are written to `/usr/src/app/exports` (Render persistent disk or ephemeral according to plan).
5. Tail container logs to confirm ML bootstrap completes once per boot.

## Troubleshooting

- Failing unit tests: see corridor generator suite – the failures are legacy and currently ignored during deploy, but keep the output for regression tracking.
- If `/health` reports `usingDist: false`, the Vite bundle is missing. Re-run `npm run vite-build` or ensure the Docker build executed successfully.
- For APS webhook delivery issues, inspect `logs/filtered_placements.log` and the `/api/aps/webhooks/:id` admin endpoints.

Document any environment-specific overrides in `PRODUCTION_VERIFICATION.md` after final smoke testing.
