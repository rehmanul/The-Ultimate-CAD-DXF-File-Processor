<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FloorPlan Pro Clean - Working System</title>
    <script>
        // Early stub: ensure any injected extension scripts that reference `content.query` do not throw
        try {
            if (typeof window.content === 'undefined') {
                Object.defineProperty(window, 'content', {
                    configurable: false,
                    enumerable: false,
                    writable: false,
                    value: { query: function () { return null; } }
                });
            } else if (typeof window.content.query === 'undefined') {
                try { window.content.query = function () { return null; }; } catch (e) { /* ignore */ }
            }

            // Suppress noisy errors coming from injected content scripts named content.js
                // Capture both event-based errors and the older window.onerror to ensure
                // we catch extension-injected errors that can run before DOMContentLoaded.
                window.onerror = function (msg, url, lineNo, colNo, error) {
                    try {
                        const src = url || (error && error.fileName) || '';
                        if (src && (src.toLowerCase().includes('content.js') || src.toLowerCase().startsWith('chrome-extension://'))) {
                            return true; // suppress
                        }
                    } catch (e) { /* ignore */ }
                    // return false to allow default handling otherwise
                    return false;
                };

                window.addEventListener('error', function (ev) {
                try {
                    const src = ev && ev.filename ? ev.filename : (ev && ev.error && ev.error.fileName) || '';
                    if (src && src.toLowerCase().includes('content.js')) {
                        // stop propagation and prevent default logging
                        ev.preventDefault && ev.preventDefault();
                        return true;
                    }
                } catch (e) { /* ignore */ }
            }, true);
        } catch (e) { /* ignore any errors in the stub */ }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <script>
        // Ensure the frontend knows where the API server is (use Render origin by default)
        window.__API_BASE__ = window.__API_BASE__ || window.location.origin || 'https://YOUR_RENDER_URL_HERE';
        // Provide a minimal safe content.query stub early to avoid extension-injected content.js from breaking the app
        try {
            if (typeof window.content === 'undefined') {
                Object.defineProperty(window, 'content', { configurable: true, enumerable: false, writable: true, value: { query: function () { return null; } } });
            } else if (typeof window.content.query === 'undefined') {
                Object.defineProperty(window.content, 'query', { configurable: true, enumerable: false, writable: true, value: function () { return null; } });
            }
        } catch (e) { /* ignore */ }
    </script>
    <div class="container" role="application" aria-label="FloorPlan Pro application">
        <div class="panel">
            <div class="logo"><i class="fas fa-cube"></i> FloorPlan Pro Clean</div>

            <h3><i class="fas fa-tools"></i> CAD Tools</h3>
            <button class="btn" id="uploadBtn" aria-label="Upload CAD file">
                <i class="fas fa-upload"></i> Upload CAD File
            </button>
            <input type="file" id="fileInput" accept=".dxf,.dwg" class="hidden" aria-label="CAD file input" />

            <h4>Îlot Generation</h4>
            <button id="generateIlotsBtn" class="btn" title="Generate ilots" aria-label="Generate ilots">
                <i class="fas fa-th-large"></i> Generate Îlots
            </button>
            <button id="optimizeLayoutBtn" class="btn">
                <i class="fas fa-magic"></i> Optimize Layout
            </button>

            <h4>Corridors</h4>
            <button id="generateCorridorsBtn" class="btn">
                <i class="fas fa-route"></i> Generate Corridors
            </button>
            <button id="optimizePathsBtn" class="btn">
                <i class="fas fa-project-diagram"></i> Optimize Paths
            </button>

            <h4>Export</h4>
            <button id="exportPdfBtn" class="btn">
                <i class="fas fa-file-pdf"></i> Export PDF
            </button>
            <button id="exportImageBtn" class="btn">
                <i class="fas fa-image"></i> Export Image
            </button>

            <h4>Configuration</h4>
            <label for="corridorWidthSlider">Corridor Width (m):</label>
            <input type="range" id="corridorWidthSlider" class="corridor-slider" min="1" max="3" step="0.1" value="1.5"
                aria-valuemin="1" aria-valuemax="3" aria-valuenow="1.5">
            <span id="corridorWidthValue">1.5m</span>

            <h4>Statistics</h4>
            <div class="stats">
                <div class="stat-card">
                    <div id="roomCount" class="stat-value">0</div>
                    <div class="stat-label">Rooms</div>
                </div>
                <div class="stat-card">
                    <div id="ilotCount" class="stat-value">0</div>
                    <div class="stat-label">Îlots</div>
                </div>
            </div>
            <div class="stat-center" role="status" aria-live="polite">
                <strong>Total Area: <span id="totalArea">0 m²</span></strong>
            </div>
        </div>

        <div class="panel main">
            <button class="toggle-btn toggle-left" id="leftToggle" title="Toggle left panel">
                <i class="fas fa-chevron-left" id="leftToggleIcon"></i>
            </button>
            <button class="toggle-btn toggle-right" id="rightToggle" title="Toggle right panel">
                <i class="fas fa-chevron-right" id="rightToggleIcon"></i>
            </button>
            <div id="threeContainer" class="canvas-wrapper" aria-live="polite" aria-label="3D canvas container"></div>
            <div class="top-controls">
                <button id="useThreeBtn" class="btn small" aria-pressed="true">Three.js</button>
                <button id="useViewerBtn" class="btn small" aria-pressed="false">Autodesk Viewer</button>
                <button id="transformDebugBtn" class="btn small">Transform Debug</button>
            </div>
        </div>

        <div class="panel">
            <h3><i class="fas fa-chart-bar"></i> Analysis Results</h3>

            <h4>Detected Rooms</h4>
            <div id="roomList">
                <div class="list-item">No rooms detected yet</div>
            </div>

            <h4>Generated Îlots</h4>
            <div id="ilotsList">
                <div class="list-item">No îlots generated yet</div>
            </div>

            <h4>Corridor Network</h4>
            <div id="corridorList">
                <div class="list-item">No corridors generated yet</div>
            </div>
        </div>
        <!-- Debug output for APS analysis (hidden by default) -->
        <pre id="aps-debug" class="aps-debug" aria-hidden="true"></pre>
    </div>

    <link rel="stylesheet" href="/styles.css">
    <script type="importmap">
        {
            "imports": {
                "three": "./libs/build/three.module.js"
            }
        }
        </script>
    <script>
        // small wiring to keep upload button accessible
        document.addEventListener('DOMContentLoaded', function () {
            const uploadBtn = document.getElementById('uploadBtn');
            const fileInput = document.getElementById('fileInput');
            if (uploadBtn && fileInput) {
                uploadBtn.addEventListener('click', () => fileInput.click());
            }
        });
    </script>
    <script type="module" src="app.js"></script>
</body>

</html>